// Generated by CoffeeScript 1.8.0
var addStorage, changeGradientShow, changeMode, clearAllItemStyle, clearWorkTable, closeSidebar, drawItemFromStorage, flushWarn, getInitFuncName, getStorageByKey, initColorPickerValue, initCommonVar, initDraggableAndResizable, initHandwrite, initHeaderMenu, initKeyEvent, loadFromServer, loadItemJs, openSidebar, popOperationHistory, popOperationHistoryRedo, pushOperationHistory, redo, run, runLookAround, saveToServer, settingColorPicker, settingGradientDegSlider, settingGradientSlider, settingGradientSliderByElement, settingSlider, setupContextMenu, showError, showWarn, switchGradientColorSelectorVisible, undo;

initCommonVar = function() {
  window.sidebarWrapper = $("#sidebar-wrapper");
  window.mainScroll = $('#main_scroll');
  window.mainWrapper = $('#main-wrapper');
  window.originalMainContainerSize = {
    w: mainWrapper.width(),
    h: mainWrapper.height()
  };
  window.cssCode = $("#cssCode");
  window.codeCache = $("#codeCache");
  window.messageTimer = null;
  window.flushMessageTimer = null;
  window.mode = Constant.Mode.DRAW;
  window.lstorage = localStorage;
  window.itemObjectList = [];
  window.itemInitFuncList = [];
  window.operationHistory = [];
  window.operationHistoryIndex = 0;
  lstorage.clear();
  window.selectItemMenu = Constant.ItemType.BUTTON;
  return loadItemJs(Constant.ItemType.BUTTON);
};

initDraggableAndResizable = function() {
  var drag, rSize;
  drag = $('.draggable');
  drag.draggable({
    containment: mainWrapper
  });
  rSize = $('.resizable');
  return rSize.resizable({
    containment: mainWrapper
  });
};

initHandwrite = function() {
  var MOVE_FREQUENCY, clicking, dragging, enableMoveEvent, item, lastX, lastY, mouseDownDrawing, mouseMoveDrawing, mouseUpDrawing, queueLoc, windowToCanvas, zindex;
  dragging = false;
  clicking = false;
  lastX = null;
  lastY = null;
  item = null;
  enableMoveEvent = true;
  queueLoc = null;
  zindex = 1;
  MOVE_FREQUENCY = 7;
  windowToCanvas = function(canvas, x, y) {
    var bbox;
    bbox = canvas.getBoundingClientRect();
    return {
      x: x - bbox.left * (canvas.width / bbox.width),
      y: y - bbox.top * (canvas.height / bbox.height)
    };
  };
  mouseDownDrawing = function(loc) {
    if (selectItemMenu === Constant.ItemType.ARROW) {
      item = new ArrowItem(loc);
    } else if (selectItemMenu === Constant.ItemType.BUTTON) {
      item = new ButtonItem(loc);
    }
    item.saveDrawingSurface();
    changeMode(Constant.Mode.DRAW);
    return item.startDraw();
  };
  mouseMoveDrawing = function(loc) {
    var q;
    if (enableMoveEvent) {
      enableMoveEvent = false;
      dragging = true;
      item.draw(loc);
      if (queueLoc !== null) {
        q = queueLoc;
        queueLoc = null;
        item.draw(q);
      }
      return enableMoveEvent = true;
    } else {
      return queueLoc = loc;
    }
  };
  mouseUpDrawing = function() {
    item.restoreAllDrawingSurface();
    item.endDraw(zindex);
    item.setupEvents();
    changeMode(Constant.Mode.EDIT);
    item.saveObj(Constant.ItemActionType.MAKE);
    return zindex += 1;
  };
  return (function(_this) {
    return function() {
      var calcCanvasLoc, saveLastLoc;
      calcCanvasLoc = function(e) {
        var x, y;
        x = e.x || e.clientX;
        y = e.y || e.clientY;
        return windowToCanvas(drawingCanvas, x, y);
      };
      saveLastLoc = function(loc) {
        lastX = loc.x;
        return lastY = loc.y;
      };
      drawingCanvas.onmousedown = function(e) {
        var loc;
        if (e.which === 1) {
          loc = calcCanvasLoc(e);
          saveLastLoc(loc);
          clicking = true;
          if (mode === Constant.Mode.DRAW) {
            e.preventDefault();
            return mouseDownDrawing(loc);
          } else if (mode === Constant.Mode.OPTION) {
            closeSidebar();
            return changeMode(Constant.Mode.EDIT);
          }
        }
      };
      drawingCanvas.onmousemove = function(e) {
        var loc;
        if (e.which === 1) {
          loc = calcCanvasLoc(e);
          if (clicking && Math.abs(loc.x - lastX) + Math.abs(loc.y - lastY) >= MOVE_FREQUENCY) {
            if (mode === Constant.Mode.DRAW) {
              e.preventDefault();
              mouseMoveDrawing(loc);
            }
            return saveLastLoc(loc);
          }
        }
      };
      return drawingCanvas.onmouseup = function(e) {
        if (e.which === 1) {
          if (dragging && mode === Constant.Mode.DRAW) {
            e.preventDefault();
            mouseUpDrawing();
          }
        }
        dragging = false;
        return clicking = false;
      };
    };
  })(this)();
};

setupContextMenu = function(element, contextSelector, menu) {
  var calMoveScrollLeft;
  calMoveScrollLeft = function(target) {
    var scrollLeft, targetMiddle;
    targetMiddle = $(target).offset().left + $(target).width() * 0.5;
    scrollLeft = targetMiddle - mainScroll.width() * 0.75 * 0.5;
    if (scrollLeft < 0) {
      scrollLeft = 0;
    } else if (scrollLeft > mainScroll.width() * 0.25) {
      scrollLeft = mainScroll.width() * 0.25;
    }
    return scrollLeft;
  };
  return element.contextmenu({
    delegate: contextSelector,
    preventContextMenuForPopup: true,
    preventSelect: true,
    menu: menu,
    select: function(event, ui) {
      var $target;
      $target = event.target;
      switch (ui.cmd) {
        case "delete":
          $target.remove();
          return;
        case "cut":
          break;
        default:
          return;
      }
      openSidebar(calMoveScrollLeft($target));
      return changeMode(Constant.Mode.OPTION);
    },
    beforeOpen: (function(_this) {
      return function(event, ui) {
        var $menu, $target, extraData;
        $target = ui.target;
        $menu = ui.menu;
        extraData = ui.extraData;
        return ui.menu.zIndex($(event.target).zIndex() + 1);
      };
    })(this)
  });
};


/* スライダーの作成 */

settingSlider = function(id, min, max, codeEmt, previewEmt, stepValue) {
  var d, defaultValue, meterElement, valueElement;
  if (typeof stepValue === 'undefined') {
    stepValue = 0;
  }
  meterElement = $('#' + id);
  valueElement = $('.' + id + '-value');
  d = $('.' + id + '-value', codeEmt)[0];
  defaultValue = $(d).html();
  valueElement.val(defaultValue);
  valueElement.html(defaultValue);
  return meterElement.slider({
    min: min,
    max: max,
    step: stepValue,
    value: defaultValue,
    slide: function(event, ui) {
      valueElement.val(ui.value);
      valueElement.html(ui.value);
      return previewEmt.text(codeEmt.text());
    }
  });
};

settingGradientSliderByElement = function(element, values, codeEmt, previewEmt) {
  var handleElement, id;
  id = element.attr("id");
  element.slider({
    values: values,
    slide: function(event, ui) {
      var index, position;
      index = $(ui.handle).index();
      position = $('.btn-bg-color' + (index + 2) + '-position', codeEmt);
      position.html(ui.value);
      return previewEmt.text(codeEmt.text());
    }
  });
  handleElement = element.children('.ui-slider-handle');
  if (values === null) {
    return handleElement.css('display', 'none');
  } else {
    return handleElement.css('display', '');
  }
};

settingGradientSlider = function(id, values, codeEmt, previewEmt) {
  var meterElement;
  meterElement = $('#' + id);
  return settingGradientSliderByElement(meterElement, values, codeEmt, previewEmt);
};

settingGradientDegSlider = function(id, min, max, codeEmt, previewEmt) {
  var d, defaultValue, meterElement, valueElement, webkitDeg, webkitValueElement;
  meterElement = $('#' + id);
  valueElement = $('.' + id + '-value');
  webkitValueElement = $('.' + id + '-value-webkit');
  d = $('.' + id + '-value', codeEmt)[0];
  defaultValue = $(d).html();
  webkitDeg = {
    0: 'left top, left bottom',
    45: 'right top, left bottom',
    90: 'right top, left top',
    135: 'right bottom, left top',
    180: 'left bottom, left top',
    225: 'left bottom, right top',
    270: 'left top, right top',
    315: 'left top, right bottom'
  };
  valueElement.val(defaultValue);
  valueElement.html(defaultValue);
  webkitValueElement.html(webkitDeg[defaultValue]);
  return meterElement.slider({
    min: min,
    max: max,
    step: 45,
    value: defaultValue,
    slide: function(event, ui) {
      valueElement.val(ui.value);
      valueElement.html(ui.value);
      webkitValueElement.html(webkitDeg[ui.value]);
      return previewEmt.text(codeEmt.text());
    }
  });
};


/* スライダーの作成 ここまで */


/* グラデーション */

changeGradientShow = function(element, codeEmt, previewEmt) {
  var meterElement, targetElement, value, values;
  targetElement = element.currentTarget;
  value = parseInt(targetElement.value);
  if (value >= 2 && value <= 5) {
    meterElement = $(targetElement).siblings('.ui-slider:first');
    values = null;
    if (value === 3) {
      values = [50];
    } else if (value === 4) {
      values = [30, 70];
    } else if (value === 5) {
      values = [25, 50, 75];
    }
    meterElement.slider("destroy");
    settingGradientSliderByElement(meterElement, values, codeEmt, previewEmt);
    return switchGradientColorSelectorVisible(value);
  }
};

switchGradientColorSelectorVisible = function(gradientStepValue) {
  var element, i, _i, _results;
  _results = [];
  for (i = _i = 2; _i <= 4; i = ++_i) {
    element = $('#btn-bg-color' + i);
    if (i > gradientStepValue - 1) {
      _results.push(element.css('display', 'none'));
    } else {
      _results.push(element.css('display', ''));
    }
  }
  return _results;
};


/* グラデーション ここまで */

initHeaderMenu = function() {
  var itemsMenuEmt, itemsSelectMenuEmt;
  itemsMenuEmt = $('#header_items_file_menu .dropdown-menu > li');
  $('.menu-open', itemsMenuEmt).on('click', function() {
    return loadFromServer();
  });
  $('.menu-save', itemsMenuEmt).on('click', function() {
    return saveToServer();
  });
  itemsSelectMenuEmt = $('#header_items_select_menu .dropdown-menu > li');
  return $('.menu-item', itemsSelectMenuEmt).on('click', function() {
    var itemType;
    itemType = parseInt($(this).attr('id').replace('menu-item-', ''));
    itemsSelectMenuEmt.removeClass('active');
    $(this).parent('li').addClass('active');
    window.selectItemMenu = itemType;
    changeMode(Constant.Mode.DRAW);
    return loadItemJs(itemType);
  });
};

getInitFuncName = function(itemType) {
  var itemName;
  itemName = Constant.ITEM_PATH_LIST[itemType];
  return itemName + "Init";
};

loadItemJs = function(itemType, callback) {
  var itemInitFuncName;
  if (callback == null) {
    callback = null;
  }
  itemInitFuncName = getInitFuncName(itemType);
  if (window.itemInitFuncList[itemInitFuncName] != null) {
    window.itemInitFuncList[itemInitFuncName]();
    if (callback != null) {
      callback();
    }
    return;
  }
  return $.ajax({
    url: "/item_js/index",
    type: "POST",
    dataType: "html",
    data: {
      itemPath: Constant.ITEM_PATH_LIST[itemType].replace(/¥-/, '/')
    },
    success: function(data) {
      var firstScript, s, t;
      s = document.createElement('script');
      s.type = 'text/javascript';
      s.src = data;
      firstScript = document.getElementsByTagName('script')[0];
      firstScript.parentNode.insertBefore(s, firstScript);
      return t = setInterval(function() {
        if (window.itemInitFuncList[itemInitFuncName] != null) {
          clearInterval(t);
          window.itemInitFuncList[itemInitFuncName]();
          if (callback != null) {
            return callback();
          }
        }
      }, '500');
    },
    error: function(data) {}
  });
};

settingColorPicker = function(element, defaultColor, onChange) {
  return $(element).ColorPicker({
    color: defaultColor,
    onShow: function(a) {
      $(a).show();
      return false;
    },
    onHide: function(a) {
      $(a).hide();
      return false;
    },
    onChange: onChange
  });
};

initColorPickerValue = function() {
  return $('.colorPicker', sidebarWrapper).each(function() {
    var color, id, inputEmt;
    id = $(this).attr('id');
    color = $('.' + id, cssCode).html();
    $(this).css('backgroundColor', '#' + color);
    inputEmt = sidebarWrapper.find('#' + id + '-input');
    return inputEmt.attr('value', color);
  });
};

changeMode = function(mode) {
  if (mode === Constant.Mode.DRAW) {
    $(window.drawingCanvas).css('z-index', Constant.ZINDEX_MAX);
  } else if (mode === Constant.Mode.EDIT) {
    $(window.drawingCanvas).css('z-index', 0);
  } else if (mode === Constant.Mode.OPTION) {
    $(window.drawingCanvas).css('z-index', Constant.ZINDEX_MAX);
  }
  return window.mode = mode;
};

clearAllItemStyle = function() {
  return itemObjectList.forEach(function(obj) {
    obj.clearAllEventStyle();
    return $('.editSelected').remove();
  });
};

openSidebar = function(scrollLeft) {
  if (scrollLeft == null) {
    scrollLeft = null;
  }
  $('#main').switchClass('col-md-12', 'col-md-9', 500, 'swing', function() {
    return $('#sidebar').fadeIn('1000');
  });
  if (scrollLeft !== null) {
    return mainScroll.animate({
      scrollLeft: scrollLeft
    }, 500);
  }
};

closeSidebar = function() {
  return $('#sidebar').fadeOut('1000', function() {
    mainScroll.animate({
      scrollLeft: 0
    }, 500);
    return $('#main').switchClass('col-md-9', 'col-md-12', 500, 'swing');
  });
};

showWarn = function(message) {
  var bottom, css, errorFooter, exist_mes, isBeforeWarnDisplay, isErrorDisplay, mes, warnDisplay, warnFooter;
  warnFooter = $('.warn-message');
  errorFooter = $('.error-message');
  warnDisplay = $('.footer-message-display', warnFooter);
  isBeforeWarnDisplay = warnDisplay.val() === "1";
  isErrorDisplay = $('.footer-message-display', errorFooter).val() === "1";
  mes = $('> div > p', warnFooter);
  if (message === void 0) {
    return;
  }
  warnDisplay.val("1");
  exist_mes = mes.html();
  if (exist_mes === null || exist_mes === "") {
    mes.html(message);
  } else {
    mes.html(exist_mes + '<br/>' + message);
  }
  if (messageTimer !== null) {
    clearTimeout(messageTimer);
  }
  if (isBeforeWarnDisplay) {
    css = {};
  } else {
    if (isErrorDisplay) {
      bottom = parseInt(errorFooter.css('bottom'), 10) + errorFooter.height() + 10;
      css = {
        bottom: bottom + 'px'
      };
    } else {
      css = {
        bottom: '20px'
      };
    }
  }
  return warnFooter.animate(css, 'fast', function(e) {
    return window.messageTimer = setTimeout(function(e) {
      var footer;
      footer = $('.footer-message');
      $('.footer-message-display', footer).val("0");
      return footer.stop().animate({
        bottom: '-30px'
      }, 'fast', function(e) {
        window.messageTimer = null;
        return $('> div > p', $(this)).html('');
      });
    }, 3000);
  });
};

showError = function(message) {
  var css, errorDisplay, errorFooter, exist_mes, isBeforeErrorDisplay, isWarnDisplay, mes, warnFooter;
  warnFooter = $('.warn-message');
  errorFooter = $('.error-message');
  errorDisplay = $('.footer-message-display', errorFooter);
  isBeforeErrorDisplay = errorDisplay.val() === "1";
  isWarnDisplay = $('.footer-message-display', warnFooter).val() === "1";
  mes = $('> div > p', errorFooter);
  if (message === void 0) {
    return;
  }
  errorDisplay.val("1");
  exist_mes = mes.html();
  if (exist_mes === null || exist_mes === "") {
    mes.html(message);
  } else {
    mes.html(exist_mes + '<br/>' + message);
  }
  if (messageTimer !== null) {
    clearTimeout(messageTimer);
  }
  if (isBeforeErrorDisplay) {
    css = {};
  } else {
    css = {
      bottom: '20px'
    };
  }
  return errorFooter.animate(css, 'fast', function(e) {
    var bottom;
    if (isWarnDisplay) {
      bottom = parseInt(errorFooter.css('bottom'), 10) + errorFooter.height() + 10;
      css = {
        bottom: bottom + 'px'
      };
      warnFooter.stop().animate(css, 'fast');
    }
    return window.messageTimer = setTimeout(function(e) {
      var footer;
      footer = $('.footer-message');
      $('.footer-message-display', footer).val("0");
      return footer.stop().animate({
        bottom: '-30px'
      }, 'fast', function(e) {
        window.messageTimer = null;
        return $('> div > p', $(this)).html('');
      });
    }, 3000);
  });
};

flushWarn = function(message) {
  var fw, mes;
  if (window.messageTimer !== null) {
    return;
  }
  if (window.flushMessageTimer !== null) {
    clearTimeout(flushMessageTimer);
  }
  fw = $('#flush_warn');
  mes = $('> div > p', fw);
  mes.html(message);
  fw.show();
  return window.flushMessageTimer = setTimeout(function(e) {
    return fw.hide();
  }, 100);
};

initKeyEvent = function() {
  return $(window).keydown(function(e) {
    var isMac;
    isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    if ((isMac && e.metaKey) || (!isMac && e.ctrlKey)) {
      if (e.keyCode === Constant.KeyboardKeyCode.Z) {
        e.preventDefault();
        if (e.shiftKey) {
          return redo();
        } else {
          return undo();
        }
      }
    }
  });
};

undo = function() {
  var action, history, obj, past, pastOperationIndex;
  if (operationHistoryIndex <= 0) {
    flushWarn("Can't Undo");
    return;
  }
  history = popOperationHistory();
  obj = history.obj;
  pastOperationIndex = obj.popOhi();
  action = history.action;
  if (action === Constant.ItemActionType.MAKE) {
    return obj.getJQueryElement().remove();
  } else if (action === Constant.ItemActionType.MOVE) {
    obj.getJQueryElement().remove();
    past = operationHistory[pastOperationIndex];
    obj = past.obj;
    obj.setSize(past.itemSize);
    obj.reDraw();
    return obj.setupEvents();
  }
};

redo = function() {
  var action, history, obj;
  if (operationHistory.length <= operationHistoryIndex) {
    flushWarn("Can't Redo");
    return;
  }
  history = popOperationHistoryRedo();
  obj = history.obj;
  obj.incrementOhiRegistIndex();
  action = history.action;
  if (action === Constant.ItemActionType.MAKE) {
    obj.setSize(history.itemSize);
    obj.reDraw();
    return obj.setupEvents();
  } else if (action === Constant.ItemActionType.MOVE) {
    obj.getJQueryElement().remove();
    obj.setSize(history.itemSize);
    obj.reDraw();
    return obj.setupEvents();
  }
};

saveToServer = function() {
  var jsonList;
  jsonList = [];
  itemObjectList.forEach(function(obj) {
    var j;
    j = {
      id: obj.getId(),
      obj: obj.generateMinimumObject()
    };
    return jsonList.push(j);
  });
  return $.ajax({
    url: "/item_state/save_itemstate",
    type: "POST",
    data: {
      user_id: 0,
      contents: JSON.stringify(jsonList)
    },
    dataType: "json",
    success: function(data) {
      return console.log(data.message);
    },
    error: function(data) {
      return console.log(data.message);
    }
  });
};

loadFromServer = function() {
  return $.ajax({
    url: "/item_state/load_itemstate",
    type: "POST",
    data: {
      user_id: 0,
      loaded_js_path_list: JSON.stringify(itemLoadedJsPathList)
    },
    dataType: "json",
    success: function(data) {
      var callback, jsList, loadedCount;
      callback = function() {
        var contents, item, itemState, j, obj, _i, _len, _results;
        clearWorkTable();
        itemState = JSON.parse(data.item_state);
        contents = JSON.parse(itemState.contents);
        _results = [];
        for (_i = 0, _len = contents.length; _i < _len; _i++) {
          j = contents[_i];
          obj = j.obj;
          item = null;
          if (obj.itemType === Constant.ItemType.BUTTON) {
            item = new ButtonItem();
          } else if (obj.itemType === Constant.ItemType.ARROW) {
            item = new ArrowItem();
          }
          item.loadByMinimumObject(obj);
          _results.push(item.setupEvents());
        }
        return _results;
      };
      jsList = JSON.parse(data.js_list);
      if (jsList.length === 0) {
        callback();
        return;
      }
      loadedCount = 0;
      return jsList.forEach(function(js) {
        var firstScript, s, t;
        s = document.createElement('script');
        s.type = 'text/javascript';
        s.src = js.src;
        firstScript = document.getElementsByTagName('script')[0];
        firstScript.parentNode.insertBefore(s, firstScript);
        return t = setInterval(function() {
          var fn;
          fn = getInitFuncName(js.item_type);
          if (window.itemInitFuncList[fn] != null) {
            clearInterval(t);
            window.itemInitFuncList[fn]();
            loadedCount += 1;
            if (loadedCount >= jsList.length) {
              return callback();
            }
          }
        }, '500');
      });
    },
    error: function(data) {
      return console.log(data.message);
    }
  });
};


/* 操作履歴 */

pushOperationHistory = function(obj) {
  operationHistory[operationHistoryIndex] = obj;
  return operationHistoryIndex += 1;
};

popOperationHistory = function() {
  operationHistoryIndex -= 1;
  return operationHistory[operationHistoryIndex];
};

popOperationHistoryRedo = function() {
  var obj;
  obj = operationHistory[operationHistoryIndex];
  operationHistoryIndex += 1;
  return obj;
};


/* WebStorage保存 */

drawItemFromStorage = function() {};

addStorage = function(id, obj) {
  return lstorage.setItem(id, obj);
};

getStorageByKey = function(key) {
  return lstorage.getItem(key);
};

clearWorkTable = function() {
  return itemObjectList.forEach(function(obj) {
    return obj.getJQueryElement().remove();
  });
};

run = function() {
  return $.ajax({
    url: "/test_move/hello",
    type: "POST",
    dataType: "html",
    success: function(data) {
      var firstScript, s, t;
      s = document.createElement('script');
      s.type = 'text/javascript';
      s.src = data;
      s.id = 'test';
      firstScript = document.getElementsByTagName('script')[0];
      firstScript.parentNode.insertBefore(s, firstScript);
      return t = setInterval(function() {
        if (typeof helloFunc === 'function') {
          clearInterval(t);
          return helloFunc();
        }
      }, '500');
    },
    error: function(data) {}
  });
};

runLookAround = function() {
  var objList;
  objList = [];
  itemObjectList.forEach(function(item) {
    if (item instanceof ArrowItem) {
      return objList.push(item.generateMinimumObject());
    }
  });
  lstorage.setItem('lookaround', JSON.stringify(objList));
  lstorage.setItem('itemLoadedJsPathList', JSON.stringify(itemLoadedJsPathList));
  return window.open('/look_around');
};

$(function() {
  var menu;
  if (!checkBlowserEnvironment()) {
    alert('ブラウザ非対応です。');
    return;
  }
  initCommonVar();
  mainWrapper.css('width', $('#main_container').width());
  $('#canvas_container').attr('width', $('#main_container').width());
  $('#canvas_container').attr('height', $('#main_container').height());
  initColorPickerValue();
  $('.dropdown-toggle').dropdown();
  initHeaderMenu();
  initKeyEvent();
  initHandwrite();
  menu = [
    {
      title: "Default",
      cmd: "default",
      uiIcon: "ui-icon-scissors"
    }
  ];
  setupContextMenu($('#main'), '#main_container', menu);
  return $('#main').on("mousedown", function() {
    return clearAllItemStyle();
  });
});

//# sourceMappingURL=work_table.js.js.map
