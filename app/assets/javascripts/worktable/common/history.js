// Generated by CoffeeScript 1.9.2
var OperationHistory;

OperationHistory = (function() {
  var _pop, _popRedo;

  function OperationHistory() {}

  OperationHistory.Key = (function() {
    function Key() {}

    Key.INSTANCE = 'iv';

    Key.EVENT = 'ev';

    return Key;

  })();

  OperationHistory.add = function(isInit) {
    var obj;
    if (isInit == null) {
      isInit = false;
    }
    if ((window.operationHistoryIndexes[window.pageNum] != null) && !isInit) {
      window.operationHistoryIndexes[window.pageNum] = (window.operationHistoryIndexes[window.pageNum] + 1) % window.operationHistoryLimit;
    } else {
      window.operationHistoryIndexes[window.pageNum] = 0;
    }
    window.operationHistoryTailIndex = window.operationHistoryIndexes[window.pageNum];
    obj = {};
    obj[this.Key.INSTANCE] = PageValue.getInstancePageValue(PageValue.Key.instancePagePrefix());
    obj[this.Key.EVENT] = PageValue.getEventPageValue(PageValue.Key.eventPagePrefix());
    if (window.operationHistories[window.pageNum] == null) {
      window.operationHistories[window.pageNum] = [];
    }
    return window.operationHistories[window.pageNum][window.operationHistoryIndexes[window.pageNum]] = obj;
  };

  _pop = function() {
    var eventPageValue, hIndex, instancePageValue, obj;
    if (window.operationHistoryIndexes[window.pageNum] == null) {
      return false;
    }
    hIndex = window.operationHistoryIndexes[window.pageNum];
    if (hIndex <= 0) {
      hIndex = window.operationHistoryLimit - 1;
    } else {
      hIndex -= 1;
    }
    if ((window.operationHistories[window.pageNum] != null) && (window.operationHistories[window.pageNum][hIndex] != null)) {
      obj = window.operationHistories[window.pageNum][hIndex];
      WorktableCommon.removeAllItemAndEvent();
      instancePageValue = obj[this.Key.INSTANCE];
      eventPageValue = obj[this.Key.EVENT];
      if (instancePageValue != null) {
        PageValue.setInstancePageValue(PageValue.Key.instancePagePrefix(), instancePageValue);
      }
      if (eventPageValue != null) {
        PageValue.setEventPageValueByPageRootHash(eventPageValue);
      }
      window.operationHistoryIndexes[window.pageNum] = hIndex;
      PageValue.adjustInstanceAndEventOnThisPage();
      LocalStorage.saveEventPageValue();
      WorktableCommon.drawAllItemFromEventPageValue();
      return true;
    } else {
      return false;
    }
  };

  _popRedo = function() {
    var eventPageValue, hIndex, instancePageValue, obj;
    if (window.operationHistoryIndexes[window.pageNum] == null) {
      return false;
    }
    hIndex = (window.operationHistoryIndexes[window.pageNum] + 1) % window.operationHistoryLimit;
    if ((window.operationHistories[window.pageNum] != null) && (window.operationHistories[window.pageNum][hIndex] != null)) {
      obj = window.operationHistories[window.pageNum][hIndex];
      WorktableCommon.removeAllItemAndEvent();
      instancePageValue = obj[this.Key.INSTANCE];
      eventPageValue = obj[this.Key.EVENT];
      if (instancePageValue != null) {
        PageValue.setInstancePageValue(PageValue.Key.instancePagePrefix(), instancePageValue);
      }
      if (eventPageValue != null) {
        PageValue.setEventPageValueByPageRootHash(eventPageValue);
      }
      window.operationHistoryIndexes[window.pageNum] = hIndex;
      PageValue.adjustInstanceAndEventOnThisPage();
      LocalStorage.saveEventPageValue();
      WorktableCommon.drawAllItemFromEventPageValue();
      return true;
    } else {
      return false;
    }
  };

  OperationHistory.undo = function() {
    var nextTailIndex;
    nextTailIndex = (window.operationHistoryTailIndex + 1) % window.operationHistoryLimit;
    if ((window.operationHistoryIndexes[window.pageNum] == null) || nextTailIndex === window.operationHistoryIndexes[window.pageNum] || !_pop.call(this)) {
      Message.flushWarn("Can't Undo");
    }
  };

  OperationHistory.redo = function() {
    if ((window.operationHistoryIndexes[window.pageNum] == null) || window.operationHistoryTailIndex === window.operationHistoryIndexes[window.pageNum] || !_popRedo.call(this)) {
      Message.flushWarn("Can't Redo");
    }
  };

  return OperationHistory;

})();

//# sourceMappingURL=history.js.map
