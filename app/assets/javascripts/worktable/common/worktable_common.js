// Generated by CoffeeScript 1.9.2
var WorktableCommon;

WorktableCommon = (function() {
  function WorktableCommon() {}

  WorktableCommon.setupContextMenu = function(element, contextSelector, menu) {
    var initOptionMenu;
    initOptionMenu = function(event) {
      var emt, obj;
      emt = $(event.target);
      obj = createdObject[emt.attr('id')];
      if ((obj != null) && (obj.setupOptionMenu != null)) {
        obj.setupOptionMenu();
      }
      if ((obj != null) && (obj.showOptionMenu != null)) {
        return obj.showOptionMenu();
      }
    };
    return element.contextmenu({
      preventContextMenuForPopup: true,
      preventSelect: true,
      menu: menu,
      select: function(event, ui) {
        var $target;
        $target = event.target;
        switch (ui.cmd) {
          case "delete":
            $target.remove();
            return;
          case "cut":
            break;
          default:
            return;
        }
        initColorPickerValue();
        initOptionMenu(event);
        Sidebar.openConfigSidebar($target);
        return changeMode(Constant.Mode.OPTION);
      },
      beforeOpen: function(event, ui) {
        return ui.menu.zIndex($(event.target).zIndex() + 1);
      }
    });
  };

  WorktableCommon.removeAllItem = function() {
    var k, ref, v;
    ref = Common.getCreatedItemObject();
    for (k in ref) {
      v = ref[k];
      if (v.getJQueryElement != null) {
        v.getJQueryElement().remove();
      }
    }
    window.createdObject = {};
    return window.instanceMap = {};
  };

  WorktableCommon.removeAllItemAndEvent = function() {
    Sidebar.closeSidebar();
    localStorage.clear();
    return Common.clearAllEventChange((function(_this) {
      return function() {
        _this.removeAllItem();
        EventConfig.removeAllConfig();
        PageValue.removeAllItemAndEventPageValue();
        return Timeline.removeAllTimeline();
      };
    })(this));
  };

  WorktableCommon.drawAllItemFromEventPageValue = function() {
    var ePageValues, i, isCommonEvent, len, needItemIds, obj;
    ePageValues = PageValue.getEventPageValueSortedListByNum();
    needItemIds = [];
    for (i = 0, len = ePageValues.length; i < len; i++) {
      obj = ePageValues[i];
      isCommonEvent = obj[EventPageValueBase.PageValueKey.IS_COMMON_EVENT];
      if (!isCommonEvent) {
        needItemIds.push(obj[EventPageValueBase.PageValueKey.ITEM_ID]);
      }
    }
    return this.loadItemJs(needItemIds, function() {
      var event, j, len1, results;
      results = [];
      for (j = 0, len1 = ePageValues.length; j < len1; j++) {
        obj = ePageValues[j];
        event = Common.getInstanceFromMap(obj);
        event.initWithEvent(obj);
        isCommonEvent = obj[EventPageValueBase.PageValueKey.IS_COMMON_EVENT];
        if (!isCommonEvent) {
          results.push(event.reDraw());
        } else {
          results.push(void 0);
        }
      }
      return results;
    });
  };

  WorktableCommon.loadItemJs = function(itemIds, callback) {
    var callbackCount, i, itemId, itemInitFuncName, len, needReadItemIds;
    if (callback == null) {
      callback = null;
    }
    if (jQuery.type(itemIds) !== "array") {
      itemIds = [itemIds];
    }
    callbackCount = 0;
    needReadItemIds = [];
    for (i = 0, len = itemIds.length; i < len; i++) {
      itemId = itemIds[i];
      itemInitFuncName = getInitFuncName(itemId);
      if (window.itemInitFuncList[itemInitFuncName] != null) {
        window.itemInitFuncList[itemInitFuncName]();
        callbackCount += 1;
        if (callbackCount >= itemIds.length) {
          if (callback != null) {
            callback();
          }
          return;
        }
      } else {
        needReadItemIds.push(itemId);
      }
    }
    return $.ajax({
      url: "/item_js/index",
      type: "POST",
      dataType: "json",
      data: {
        itemIds: needReadItemIds
      },
      success: function(data) {
        var d, j, len1, option, results;
        callbackCount = 0;
        results = [];
        for (j = 0, len1 = data.length; j < len1; j++) {
          d = data[j];
          if (d.css_info != null) {
            option = {
              isWorkTable: true,
              css_temp: d.css_info
            };
          }
          WorktableCommon.availJs(getInitFuncName(d.item_id), d.js_src, option, function() {
            callbackCount += 1;
            if ((callback != null) && callbackCount >= data.length) {
              return callback();
            }
          });
          PageValue.addItemInfo(d.item_id, d.te_actions);
          results.push(EventConfig.addEventConfigContents(d.item_id, d.te_actions, d.te_values));
        }
        return results;
      },
      error: function(data) {}
    });
  };

  WorktableCommon.availJs = function(initName, jsSrc, option, callback) {
    var firstScript, s, t;
    if (option == null) {
      option = {};
    }
    if (callback == null) {
      callback = null;
    }
    s = document.createElement('script');
    s.type = 'text/javascript';
    s.src = jsSrc;
    firstScript = document.getElementsByTagName('script')[0];
    firstScript.parentNode.insertBefore(s, firstScript);
    return t = setInterval(function() {
      if (window.itemInitFuncList[initName] != null) {
        clearInterval(t);
        window.itemInitFuncList[initName](option);
        if (callback != null) {
          return callback();
        }
      }
    }, '500');
  };

  return WorktableCommon;

})();

//# sourceMappingURL=worktable_common.js.map
